name: "Terraform CI: Auto-PR & Validation"

# Trigger: Runs on every push to feature branches (ignores main)
on:
  push:
    branches-ignore:
      - main

# Permissions: Required for OIDC (AWS) and creating PRs (GitHub)
permissions:
  id-token: write       # Allow connecting to AWS without keys
  contents: read        # Allow reading the repo code
  pull-requests: write  # Allow the bot to open/comment on PRs

env:
  AWS_REGION: "ap-south-1"  # Set your AWS region
  TF_VERSION: "1.5.0"   # Pin your version for consistency

jobs:
  # ------------------------------------------------------------------
  # JOB 1: CODE QUALITY & SECURITY SCAN
  # "Fail Fast" - If syntax or security is bad, stop immediately.
  # ------------------------------------------------------------------
  static-checks:
    name: "Static Analysis"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Check Formatting (fmt)
        # Fails if code isn't formatted with 'terraform fmt'
        run: terraform fmt -check -recursive

      - name: Security Scan (tfsec)
        # Scans for vulnerabilities (e.g., open S3 buckets, 0.0.0.0/0 rules)
        uses: aquasecurity/tfsec-action@v1.0.0
        with:
          soft_fail: true # Set to 'false' to block PRs on security issues

  # ------------------------------------------------------------------
  # JOB 2: VALIDATE & PLAN (The Logic Check)
  # Connects to AWS to verify the infrastructure changes are possible.
  # ------------------------------------------------------------------
  verify-logic:
    name: "Verify Logic"
    needs: static-checks # Wait for formatting/security to pass
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Securely Connect to AWS (No Access Keys!)
      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: arn:aws:iam::312530021679:role/GitHubActions-Terraform-Role
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}

      # --- STAGE VALIDATION (The Target) ---
      - name: Plan Stage
        working-directory: ./terraform/environments/stage  # Adjust path as needed
        run: |
          terraform init
          terraform validate
          # -lock=false speeds up CI and prevents blocking your team
          terraform plan -input=false -lock=false

      # --- PROD VALIDATION (The Safety Check) ---
      # Crucial: Ensures shared module changes don't break Prod syntax
      - name: Validate Prod (Syntax Only)
        working-directory: ./terraform/environments/prod
        run: |
          terraform init -backend=false
          terraform validate

  # ------------------------------------------------------------------
  # JOB 3: AUTO-PR CREATION
  # Only runs if the code is perfect (Green Checks âœ…)
  # ------------------------------------------------------------------
  create-pr:
    name: "Open Pull Request"
    needs: verify-logic
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Create or Update PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Built-in secret
        run: |
          # 1. Check if PR exists
          EXISTING_PR=$(gh pr list --head ${{ github.ref_name }} --json url --jq '.[0].url')

          if [ -n "$EXISTING_PR" ]; then
            echo "PR already exists: $EXISTING_PR. Skipping creation."
            exit 0
          fi

          # 2. Create PR if none exists
          gh pr create \
            --base main \
            --head ${{ github.ref_name }} \
            --draft \
            --title "feat: Changes to ${{ github.ref_name }}" \
            --body "### ðŸ¤– Automated Terraform PR
            
            **Status:** âœ… Terraform Plan Successful.
            **Security:** âœ… tfsec Scan Passed.
            
            _This is a Draft PR. Click 'Ready for Review' when you are done._"